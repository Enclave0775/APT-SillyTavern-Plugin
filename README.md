# Auto Prompt Toggler (APT)

這是一個 SillyTavern 的擴充功能，能夠根據聊天訊息的內容自動切換（開啟/關閉/切換）Chat Completion 提示詞（Prompt）。

## ✨ 功能特點

*   **自動化控制**：設定規則，當 AI 回覆的內容符合特定條件（Regex）時，自動觸發提示詞狀態改變。
*   **多目標控制**：單一規則可同時控制多個提示詞，支援多選操作。
*   **設定檔管理**：
    *   支援建立多個設定檔 (Profile)，可針對不同場景切換整組規則。
    *   設定檔支援獨立匯出與匯入，方便分享與備份。
*   **靈活的操作**：支援三種動作：
    *   **開啟 (Enable)**：強制開啟指定提示詞。
    *   **關閉 (Disable)**：強制關閉指定提示詞。
    *   **切換 (Toggle)**：反轉目前提示詞的狀態。
    *   **反向動作 (Inverse Action)**：支援設定「若正則沒對應到則執行反向動作」。
        *   若設定動作為 **開啟**，沒對應到時則執行 **關閉**。
        *   若設定動作為 **關閉**，沒對應到時則執行 **開啟**。
*   **規則管理**：
    *   新增、複製、編輯、刪除規則。
    *   個別啟用或停用規則。
    *   規則列表優化顯示，多選時自動顯示數量。
    *   支援匯出單一規則。
*   **偵測來源設定**：
    *   支援針對每條規則個別設定偵測來源（聊天顯示內容 / 原始訊息內容）。
    *   可解決部分插件（如 Regex 插件）修改顯示內容導致無法偵測的問題。
*   **安全與穩定**：
    *   引入 HTML 轉義防止 XSS。
    *   保留詳細除錯資訊 (Active CharID, Prompts Count)。
*   **即時回饋**：當規則觸發時，會顯示通知提示。

## 🚀 使用方法

1.  **安裝插件**：
    1.  開啟 SillyTavern。
    2.  點擊頂部工具列中的「擴充功能 (Extensions)」按鈕。
    3.  點擊「安裝擴充功能 (Install Extension)」。
    4.  將此 URL 複製到輸入欄位中： `https://github.com/Enclave0775/APT-SillyTavern-Plugin`
    5.  點擊「僅為我安裝 (Install just for me)」或「為所有使用者安裝 (Install for all users)」。

2.  **設定規則**：
    *   開啟 SillyTavern 的 **擴充功能 (Extensions)** 面板。
    *   找到 **自動提示詞切換規則 (Auto Prompt Toggler)** 設定區塊。
    *   **設定檔管理**：
        *   使用上方工具列切換設定檔。
        *   功能按鈕：新增 (+)、匯入 (📥)、重新命名 (✏️)、匯出 (📤)、刪除 (🗑️)。
    *   點擊 **新增規則 (Add Rule)**。
    *   **偵測來源 (Detection Source)**：選擇要偵測的內容來源。
        *   **聊天顯示 (Chat Display)**：預設值，偵測聊天視窗中顯示的內容（受其他插件影響）。
        *   **原始內容 (Raw Content)**：偵測原始訊息內容，不受顯示修改影響（例如被 Regex 插件隱藏的內容）。
    *   **觸發條件 (Trigger)**：輸入正規表達式 (Regex)。例如：`Chapter \d+` 會匹配 "Chapter 1" 等文字。
    *   **目標提示詞 (Target Prompts)**：勾選要控制的提示詞 (支援多選)。
    *   **動作 (Action)**：選擇要執行的動作 (Enable/Disable/Toggle)。
    *   **若正則沒對應到則執行反向動作 (Inverse Action on No Match)**：勾選此選項後，當內容不符合正則條件時，會執行反向動作 (例如：設定開啟 -> 沒對應到則關閉)。
    *   點擊 **儲存 (Save)**。

3.  **實際運作**：
    *   當 AI 的回覆內容匹配到您設定的 Trigger 時，插件會自動執行對應的動作，並調整提示詞的狀態。

## 📂 匯入與匯出

*   **設定檔匯出/匯入**：針對整個設定檔進行備份與還原。
*   **規則匯出/匯入**：
    *   **匯出**：可以單獨匯出特定規則。
    *   **匯入**：將規則匯入到當前設定檔中 (附加模式)。

## ⚠️ 注意事項

*   此插件依賴 `promptManager(SillyTavern原生自帶)`，請確保您的 SillyTavern 版本支援該功能。
*   觸發條件使用 JavaScript 的 `RegExp` 進行匹配 (Case Insensitive 不分大小寫)。

## 👤 作者

Enclave_X
